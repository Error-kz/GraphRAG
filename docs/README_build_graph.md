# 图谱构建脚本使用说明

## 功能

根据推断出的图模式配置文件，自动构建知识图谱。

## 使用方法

### 基本用法

```bash
python scripts/build_graph.py config/schemas/your_domain_schema_v1.0.json data/raw/your_data.jsonl
```

### 参数说明

- `schema_file` (必需): 模式配置文件路径  
  - 格式：`config/schemas/{domain}_schema_v{version}.json`
  
- `data_file` (必需): 数据文件路径  
  - 支持格式：JSONL (.jsonl)、JSON (.json)、CSV (.csv)
  
- `--clear` (可选): 清空现有图谱
  - 使用此选项会删除所有现有节点和关系
  - **谨慎使用**，建议先备份数据
  
- `--batch-size` (可选): 批量处理大小
  - 默认值：100
  - 控制批量创建节点和关系的大小

### 示例

```bash
# 基本构建（不清空现有数据）
python scripts/build_graph.py config/schemas/your_domain_schema_v1.0.json data/raw/your_data.jsonl

# 清空现有图谱后重新构建
python scripts/build_graph.py config/schemas/your_domain_schema_v1.0.json data/raw/your_data.jsonl --clear

# 使用自定义批量大小
python scripts/build_graph.py config/schemas/your_domain_schema_v1.0.json data/raw/your_data.jsonl --batch-size 200
```

## 工作流程

脚本执行以下步骤：

1. **加载推断出的图模式**
   - 从模式配置文件加载节点和关系定义
   - 识别主实体和关联实体

2. **读取完整数据文件**
   - 逐行读取数据文件
   - 解析每条数据记录

3. **根据模式动态解析数据**
   - 识别主实体（如：Entity）
   - 识别关联实体（如：Category/Tag 等）
   - 识别关系（基于字段名自动映射）

4. **批量创建节点和关系**
   - 批量创建所有节点
   - 批量创建主实体节点（带完整属性）
   - 批量创建关系

5. **验证图谱完整性**
   - 统计节点数量
   - 统计关系数量
   - 输出构建摘要

## 输出示例（示意）

```
================================================================================
开始图谱构建流程
================================================================================

[步骤1] 加载推断出的图模式...
✅ 模式加载成功
  领域: your_domain
  版本: 1.0
  节点类型: 3 个
  关系类型: 2 个

[步骤2] 读取完整数据文件: data/raw/your_data.jsonl
  已解析 100 条数据...
✅ 数据读取完成，共 1000 条记录
  主实体数量: 1000
  关系数量: 3000

[步骤3] 数据解析完成
  识别到的主实体: Entity (1000 个)
  识别到的关联实体: Category (200 个)
  ...

[步骤4] 批量创建节点和关系...
  创建 Category 节点 (200 个)...
    ✅ Category 节点创建完成
  创建 Entity 节点 (1000 个)...
    ✅ Entity 节点创建完成
  创建关系 (3000 条)...
    ✅ belongs_to 关系创建完成 (3000 条)
    ...

[步骤5] 验证图谱完整性...

================================================================================
图谱构建完成！
================================================================================

节点统计:
  Entity: 1000 个
  Category: 200 个
  ...

关系统计:
  belongs_to: 3000 条
  ...
================================================================================
```

## 注意事项

1. **Neo4j 连接**：
   - 确保 Neo4j 数据库已启动
   - 检查 `.env` 文件中的 Neo4j 配置

2. **数据格式**：
   - 数据文件必须是有效的 JSONL/JSON/CSV 格式
   - 每条记录应包含主实体的 `name` 字段

3. **模式匹配**：
   - 确保模式配置文件与数据文件匹配
   - 字段名会自动映射到关系类型

4. **性能优化**：
   - 大批量数据建议使用较大的 `batch_size`
   - 首次构建建议使用 `--clear` 选项

5. **错误处理**：
   - 解析失败的数据行会被跳过并记录警告
   - 创建失败的节点/关系会记录错误但不会中断流程

## 故障排除

### 错误：模式文件不存在

**解决方案**：检查模式文件路径是否正确

### 错误：Neo4j 连接失败

**解决方案**：
1. 检查 Neo4j 是否已启动
2. 检查 `.env` 文件中的 Neo4j 配置
3. 验证用户名和密码是否正确

### 错误：数据解析失败

**解决方案**：
1. 检查数据文件格式是否正确
2. 查看警告信息，定位问题数据行
3. 确保数据字段与模式定义匹配

## 下一步

构建完成后，可以：
1. 使用 Neo4j Browser 查看图谱
2. 使用 NL2Cypher 功能查询图谱
3. 验证图谱数据的完整性

