# 上下文增强模块

## 功能概述

上下文增强模块用于从对话历史中提取信息，增强用户问题，解决指代性问题。

## 核心功能

### 1. 指代检测 (`has_reference_pronouns`)

检测用户问题是否包含指代性词语，如：
- "有什么"、"哪些"、"什么"
- "怎么"、"如何"、"怎样"
- "这个"、"那个"、"它"、"该"、"此"
- "还"、"也"、"又"、"再"、"继续"、"更多"、"其他"

### 2. 实体提取 (`extract_entities_from_history`)

**使用大模型进行智能提取**，从对话历史中提取主题实体：
- **疾病**：提取对话中讨论的主要疾病名称（如：感冒、高血压、糖尿病等）
- **症状**：提取主要症状
- **药物**：提取主要药物
- **主题关键词**：提取对话的核心主题（通常是疾病或症状名称）

**提取策略**：
1. 使用 DeepSeek 大模型分析对话历史
2. 通过精心设计的提示词引导模型提取医学实体
3. 返回结构化的 JSON 结果
4. 如果大模型提取失败，自动回退到简单的正则表达式提取策略

### 3. 问题增强 (`enhance_query_with_context`)

根据对话历史增强用户问题：

**示例：**
- 原始问题：`有什么特效药？`
- 增强后：`感冒有什么特效药？`（根据对话历史，知道当前对话框中聊的是感冒）

**增强规则：**
- 如果问题包含"有什么"或"哪些"，在问题前添加主题：`{主题}{问题}`
- 如果问题包含"怎么"、"如何"、"怎样"，在问题前添加主题：`{主题}{问题}`
- 如果问题包含"什么"，在问题前添加主题：`{主题}{问题}`
- 其他情况，在问题前添加主题和逗号：`{主题}，{问题}`

## 使用方式

```python
from core.context.enhancer import enhance_query_with_context
from core.cache.redis_client import get_redis_client, get_session_conversations

# 获取对话历史
redis_client = get_redis_client()
history = get_session_conversations(redis_client, session_id)

# 增强问题
enhanced_query, was_enhanced = enhance_query_with_context(
    query="有什么特效药？",
    history=history,
    max_history=5  # 最多使用最近5条历史记录
)

if was_enhanced:
    print(f"问题已增强: {enhanced_query}")
```

## 工作流程

1. **检测指代**：检查当前问题是否包含指代性词语
2. **提取实体**：如果有历史记录，从最近的历史记录中提取主题实体
3. **增强问题**：如果找到主题实体，将主题添加到问题前
4. **返回结果**：返回增强后的问题和是否进行了增强的标志

## 注意事项

- 如果问题已经包含主题实体，不会重复添加
- 如果没有历史记录或找不到主题实体，返回原问题
- 最多使用最近5条历史记录来提取实体（可通过 `max_history` 参数调整）
- 使用大模型提取时，如果 API 调用失败，会自动回退到简单的正则表达式提取策略
- 大模型提取使用较低温度（0.1）以提高准确性

## 技术实现

### 大模型提取流程

1. **构建对话历史文本**：将最近的历史记录格式化为文本
2. **调用 DeepSeek API**：使用精心设计的提示词引导模型提取实体
3. **解析 JSON 结果**：从模型返回的文本中提取 JSON 格式的实体信息
4. **回退策略**：如果大模型提取失败，使用简单的正则表达式从第一个问题中提取主题

